# Phase 2: Redis 분산 락(Distributed Lock) 부하 테스트 결과 분석

> 테스트 일시: 2025-12-21 17:40:52 ~ 17:42:02

---

## 1. 테스트 환경

### 1.1 인프라 구성

| 구성 요소 | 스펙 |
|:---|:---|
| **Application Server** | Local (Windows) |
| **Database** | MySQL 8.0 (Docker) |
| **Redis** | Redis 7 Alpine (Docker) |
| **JDK** | Java 21 |
| **Framework** | Spring Boot 3.4.1 |
| **분산 락 라이브러리** | Redisson 3.40.2 |
| **부하 테스트 도구** | nGrinder 3.9.1 |

### 1.2 테스트 설정

| 항목 | 설정값 |
|:---|:---|
| **VUser** | 1,500명 |
| **Duration** | 약 70초 |
| **Agent** | 1대 |
| **동시성 제어** | Redis 분산 락 (Redisson RLock) |
| **쿠폰 수량** | 1,000개 |

### 1.3 Redis 락 설정

| 항목 | 설정값 | 설명 |
|:---|:---:|:---|
| **Lock Key** | `coupon:lock` | 단일 글로벌 락 |
| **Wait Time** | 30초 | 락 획득 대기 최대 시간 |
| **Lease Time** | 30초 | 락 보유 최대 시간 |

---

## 2. 테스트 결과 요약

### 2.1 핵심 지표

| 지표 | 측정값 | 목표 | 달성 여부 |
|:---|:---:|:---:|:---:|
| **평균 TPS** | 39.3 | 10,000+ | ❌ |
| **최대 TPS** | 60.0 | - | - |
| **최소 TPS** | 8.5 | - | - |
| **평균 응답시간** | 30,120ms | < 100ms | ❌ |
| **최소 응답시간** | 7,244ms | - | - |
| **최대 응답시간** | 40,492ms | - | - |
| **에러율** | 0% | 0% | ✅ |
| **총 처리 건수** | 2,832건 | - | - |

### 2.2 데이터 정합성 검증

| 항목 | 값 | 검증 |
|:---|:---:|:---:|
| **등록된 사용자 수** | 3,000명 | ✅ |
| **발급된 쿠폰 수** | 1,000개 | ✅ |
| **남은 쿠폰 수** | 0개 | ✅ |
| **Overselling 발생** | 없음 | ✅ |

### 2.3 결과 판정

```
TPS: 39.3 / 10,000 (목표 대비 0.39% 달성)
응답시간: 30,120ms (목표 대비 301배 초과)
에러율: 0% (목표 달성)
데이터 정합성: 100% (Overselling 없음)
```

---

## 3. 상세 분석

### 3.1 시간대별 TPS 추이

![img.png](image/phase2/시간대별%20TPS.png)

### 3.2 시간대별 응답시간 추이

![img_1.png](image/phase2/시간대별%20응답시간.png)

**응답시간이 초기에 급격히 증가한 후 37~40초 수준에서 안정화되는 패턴을 보입니다.**

### 3.3 Raw 데이터 (샘플)

| 시간 | VUser | Tests | Errors | Mean Time (ms) | TPS |
|:---|:---:|:---:|:---:|:---:|:---:|
| 08:40:52 | 1,500 | 17 | 0 | 7,244 | 8.5 |
| 08:40:56 | 1,500 | 67 | 0 | 11,472 | 33.5 |
| 08:41:04 | 1,500 | 82 | 0 | 18,035 | 41.0 |
| 08:41:10 | 1,500 | 108 | 0 | 21,836 | **54.0** |
| 08:41:14 | 1,500 | 113 | 0 | 24,535 | **56.5** |
| 08:41:24 | 1,500 | 104 | 0 | 31,614 | 52.0 |
| 08:41:38 | 1,500 | 56 | 0 | 40,492 | 28.0 |
| 08:41:44 | 1,500 | 120 | 0 | 39,008 | **60.0** |
| 08:41:50 | 1,500 | 113 | 0 | 37,787 | 56.5 |

### 3.4 응답시간 분포

| 구간 | 빈도 | 비율 |
|:---|:---:|:---:|
| 5,000ms ~ 15,000ms | 5회 | 13.9% |
| 15,000ms ~ 25,000ms | 7회 | 19.4% |
| 25,000ms ~ 35,000ms | 7회 | 19.4% |
| 35,000ms ~ 42,000ms | 17회 | 47.2% |

**대부분의 요청(47.2%)이 35초 ~ 42초 구간에서 처리되었습니다.**

### 3.5 TPS 변동성 분석

| 지표 | 값 |
|:---|:---|
| **평균 TPS** | 39.3 |
| **최대 TPS** | 60.0 |
| **최소 TPS** | 8.5 |
| **TPS 범위** | 8.5 ~ 60.0 |

VUser 1,500명 상황에서 TPS가 안정적으로 39.3을 유지하며, 최대 60 TPS까지 처리되었습니다.

---

## 4. 병목 지점 분석

### 4.1 Redis 분산 락의 동작 원리

```
[요청 1] ─┐
[요청 2] ─┤
[요청 3] ─┼─▶ [Redis Lock 획득 대기] ─▶ [순차 처리] ─▶ [DB 저장] ─▶ [응답]
  ...     │           ↑
[요청 N] ─┘      Pub/Sub 기반 대기
                (스핀락 아님)
```

### 4.2 발견된 병목

| 병목 지점 | 원인 | 영향 |
|:---|:---|:---|
| **단일 글로벌 락** | 모든 요청이 하나의 락 경쟁 | 순차 처리 |
| **락 대기열 누적** | 1,500 VUser 동시 대기 | 응답시간 30~40초 |
| **직렬화 처리** | 한 번에 1개 요청만 처리 | TPS 제한 (39.3) |

### 4.3 리틀의 법칙(Little's Law) 적용

```
L = λ × W

L (시스템 내 평균 요청 수) = 1,500 VUser
W (평균 응답시간) = 30.12초
λ (TPS) = L / W = 1,500 / 30.12 ≈ 49.8 TPS
```

측정된 TPS(39.3)가 이론값(49.8)보다 낮은 것은 **락 획득 오버헤드와 네트워크 지연**이 존재함을 의미합니다.

### 4.4 Phase 1 vs Phase 2 성능 비교

| 지표 | Phase 1 (DB Lock) | Phase 2 (Redis Lock) | 변화 |
|:---|:---:|:---:|:---:|
| **VUser** | 600 | 1,500 | +150% |
| **평균 TPS** | 24.6 | 39.3 | **+59.8%** |
| **평균 응답시간** | 18,942ms | 30,120ms | +59.0% |
| **최대 응답시간** | 28,870ms | 40,492ms | +40.2% |
| **에러율** | 0% | 0% | 동일 |
| **데이터 정합성** | 100% | 100% | 동일 |
| **총 처리량** | 2,063건 | 2,832건 | **+37.3%** |

### 4.5 동일 조건 예상 비교 (VUser 600 기준)

Phase 2를 VUser 600으로 환산 시:

```
예상 TPS = 39.3 × (600/1500) ≈ 15.7 TPS
예상 응답시간 = 30,120 × (600/1500) ≈ 12,048ms
```

| 지표 | Phase 1 (600 VUser) | Phase 2 (600 VUser 환산) |
|:---|:---:|:---:|
| **TPS** | 24.6 | ~15.7 |
| **응답시간** | 18.9초 | ~12초 |

---

## 5. 성능 지표 요약

### 5.1 주요 성능 지표

| 지표 | 값 | 비고 |
|:---|:---:|:---|
| **Avg TPS** | 39.3 | 목표(10,000) 대비 0.39% |
| **Max TPS** | 60.0 | 순간 최대 처리량 |
| **Min TPS** | 8.5 | 초기 Ramp-up 시 |
| **Avg Latency** | 30,120ms | 목표(100ms) 대비 301배 |
| **Min Latency** | 7,244ms | 초기 (락 대기 적음) |
| **Max Latency** | 40,492ms | 락 대기열 최대 시 |
| **Error Rate** | 0% | 목표 달성 |
| **Throughput** | 2,832건 | 총 처리량 |

### 5.2 처리량 분석

| 항목 | 값 |
|:---|:---|
| 총 처리 건수 | 2,832건 |
| 등록된 사용자 | 3,000명 |
| 쿠폰 발급 성공 | 1,000건 |
| 쿠폰 소진 후 거절 (410) | 1,832건 |
| 발급 성공률 | 35.3% |

---

## 6. 결론

### 6.1 Phase 2 결과 요약

| 항목 | 결과 |
|:---|:---|
| **성능** | TPS 39.3으로 Phase 1(24.6) 대비 59.8% 향상 |
| **응답시간** | 평균 30.1초 (VUser 1,500 기준) |
| **안정성** | 에러율 0%로 안정적 |
| **정합성** | 정확히 1,000개 발급, Overselling 없음 |

### 6.2 Redis 분산 락의 특성

**장점:**
1. **분산 환경 지원**: 멀티 서버 환경에서도 동작 가능
2. **DB 부하 분산**: 락 경합이 Redis에서 처리
3. **데이터 정합성**: 에러율 0%, Overselling 완벽 차단
4. **Pub/Sub 효율성**: 스핀락 대비 CPU 효율적
5. **높은 VUser 처리**: 1,500 VUser에서도 안정적 동작

**한계:**
1. **단일 글로벌 락**: 모든 요청이 하나의 락을 경쟁
2. **순차 처리**: 병렬 처리 불가
3. **응답시간 증가**: VUser 증가에 비례하여 대기 시간 증가

### 6.3 개선 방향

```
현재 문제: 단일 글로벌 락으로 인한 직렬화

Phase 3 개선 방향:
- Redis INCR 원자적 카운터로 락 없이 수량 제어
- 선착순 1,000명 초과 시 즉시 거절 (Fast Fail)
- 락 획득 없이 원자적 연산으로 TPS 대폭 향상 기대
```

---

## 7. Phase 1 vs Phase 2 최종 비교

| 항목 | Phase 1 (DB Lock) | Phase 2 (Redis Lock) | 비고 |
|:---|:---:|:---:|:---|
| **VUser** | 600 | 1,500 | Phase 2가 2.5배 높음 |
| **TPS** | 24.6 | 39.3 | Phase 2 우수 |
| **총 처리량** | 2,063건 | 2,832건 | Phase 2 우수 |
| **에러율** | 0% | 0% | 동률 |
| **정합성** | 100% | 100% | 동률 |
| **분산 환경** | 불가 | 가능 | Phase 2 우수 |

**결론**: Phase 2(Redis Lock)가 더 높은 동시 접속자(VUser)를 처리하면서도 더 높은 TPS를 달성했습니다. 분산 환경 지원과 DB 부하 분산 측면에서도 Phase 2가 우수합니다.